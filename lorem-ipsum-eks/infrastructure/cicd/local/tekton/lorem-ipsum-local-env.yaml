apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: tf-destroy
  namespace: tekton-pipelines
spec:
  workspaces:
    - name: source
    - name: terraform
    - name: secrets
    - name: kube-config
      mountPath: /secrets/.kube
  params:
    - name: path
      type: string
      description: Path to tf files
      default: ""
    - name: namespace
      type: string
      description: Kubernetes namespace
      default: ""
  steps:
    - name: prepare
      image: alpine
      script: |
        #!/bin/sh
        ls $(inputs.params.path)
        echo $(workspaces.source.path)
        echo $(workspaces.terraform.path)
        echo $(workspaces.secrets.path)
        ls $(workspaces.terraform.path)
        ls $(workspaces.kube-config.path)
    - name: init
      image: docker.io/hashicorp/terraform:light
      workingDir: $(inputs.params.path)
      command: [ "terraform" ]
      args:
        - init
        - -reconfigure
        - -backend-config=$(inputs.params.namespace).tfbackend
    - name: destroy
      image: docker.io/hashicorp/terraform:light
      workingDir: $(inputs.params.path)
      command: [ "terraform" ]
      args:
        - destroy
        - -auto-approve
        - -var-file=$(inputs.params.namespace).tfvars
---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: tf-apply
  namespace: tekton-pipelines
spec:
  workspaces:
    - name: source
    - name: terraform
    - name: secrets
    - name: kube-config
      mountPath: /secrets/.kube
  params:
    - name: path
      type: string
      description: Path to tf files
      default: ""
    - name: namespace
      type: string
      description: Kubernetes namespace
      default: ""
  steps:
    - name: prepare
      image: alpine
      script: |
        #!/bin/sh
        ls $(inputs.params.path)
        echo $(workspaces.source.path)
        echo $(workspaces.terraform.path)
        echo $(workspaces.secrets.path)
        ls $(workspaces.terraform.path)
        ls $(workspaces.kube-config.path)
    - name: init
      image: docker.io/hashicorp/terraform:light
      workingDir: $(inputs.params.path)
      command: [ "terraform" ]
      args:
        - init
        - -reconfigure
        - -backend-config=$(inputs.params.namespace).tfbackend
    - name: apply
      image: docker.io/hashicorp/terraform:light
      workingDir: $(inputs.params.path)
      command: [ "terraform" ]
      args:
        - apply
        - -auto-approve
        - -var-file=$(inputs.params.namespace).tfvars
---
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: lorem-ipsum-tf-apply
  namespace: tekton-pipelines
spec:
  workspaces:
    - name: source
    - name: terraform
    - name: secrets
    - name: kube-config
  params:
    - name: image-url
      type: string
      description: Docker registry image url.
    - name: repo-url
      type: string
      description: The git repository URL to clone from.
    - name: branch-name
      type: string
      description: The git depth to clone.
    - name: argocd-repo-url
      type: string
      description: The git repository URL to clone from.
    - name: argocd-branch-name
      type: string
      description: The git depth to clone.
    - name: depth
      type: string
      description: The clone depth.
      default: "0"
    - name: namespace
      type: string
      description: The kube namespace.
      default: ""
    - name: tf-path
      type: string
      description: The kube namespace.
      default: "Path for terraform files"

  tasks:
    - name: clean
      taskRef:
        name: clean
      workspaces:
        - name: source
          workspace: source
    - name: fetch-source-repo
      taskRef:
        name: git-clone
      runAfter:
        - clean
      workspaces:
        - name: output
          workspace: source
      params:
        - name: url
          value: $(params.repo-url)
        - name: revision
          value: $(params.branch-name)
        - name: depth
          value: $(params.depth)
    - name: tf-apply
      taskRef:
        name: tf-apply
      runAfter:
        - fetch-source-repo
      params:
        - name: namespace
          value: $(params.namespace)
        - name: path
          value: $(params.tf-path)
      workspaces:
        - name: source
          workspace: source
        - name: terraform
          workspace: terraform
        - name: secrets
          workspace: secrets
        - name: kube-config
          workspace: kube-config
---
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: lorem-ipsum-tf-destroy
  namespace: tekton-pipelines
spec:
  workspaces:
    - name: source
    - name: terraform
    - name: secrets
    - name: kube-config
  params:
    - name: image-url
      type: string
      description: Docker registry image url.
    - name: repo-url
      type: string
      description: The git repository URL to clone from.
    - name: branch-name
      type: string
      description: The git depth to clone.
    - name: argocd-repo-url
      type: string
      description: The git repository URL to clone from.
    - name: argocd-branch-name
      type: string
      description: The git depth to clone.
    - name: depth
      type: string
      description: The clone depth.
      default: "0"
    - name: namespace
      type: string
      description: The kube namespace.
      default: ""
    - name: tf-path
      type: string
      description: The kube namespace.
      default: ""
  tasks:
    - name: clean
      taskRef:
        name: clean
      workspaces:
        - name: source
          workspace: source
    - name: fetch-source-repo
      taskRef:
        name: git-clone
      runAfter:
        - clean
      workspaces:
        - name: output
          workspace: source
      params:
        - name: url
          value: $(params.repo-url)
        - name: revision
          value: $(params.branch-name)
        - name: depth
          value: $(params.depth)

    - name: tf-destroy
      taskRef:
        name: tf-destroy
      runAfter:
        - fetch-source-repo
      params:
        - name: namespace
          value: $(params.namespace)
        - name: path
          value: $(params.tf-path)
      workspaces:
        - name: source
          workspace: source
        - name: terraform
          workspace: terraform
        - name: secrets
          workspace: secrets
        - name: kube-config
          workspace: kube-config
---
apiVersion: tekton.dev/v1beta1
kind: PipelineRun
metadata:
  name: lorem-ipsum-tf-destroy
  namespace: tekton-pipelines
spec:
  serviceAccountName: git-push-service-account
  pipelineRef:
    name: lorem-ipsum-tf-destroy
  params:
    - name: repo-url
      value: git@github.com:adriandolha/cloud-demo.git
    - name: branch-name
      value: master
    - name: argocd-repo-url
      value: git@github.com:adriandolha/lorem-ipsum-argocd.git
    - name: argocd-branch-name
      value: main
    - name: image-url
      value: "docker-registry.demo:5000/lorem-ipsum"
    - name: namespace
      value: "dev-lorem-ipsum"
    - name: tf-path
      value: $(workspaces.source.path)/lorem-ipsum-eks/infrastructure/local
  workspaces:
    - name: source
      persistentVolumeClaim:
        claimName: lorem-ipsum-source-ws
      subPath: source
    - name: terraform
      persistentVolumeClaim:
        claimName: lorem-ipsum-source-ws
      subPath: terraform
    - name: secrets
      persistentVolumeClaim:
        claimName: lorem-ipsum-source-ws
    - name: kube-config
      secret:
        secretName: kube-config-file
---
apiVersion: tekton.dev/v1beta1
kind: PipelineRun
metadata:
  name: lorem-ipsum-tf-apply
  namespace: tekton-pipelines
spec:
  serviceAccountName: git-push-service-account
  pipelineRef:
    name: lorem-ipsum-tf-apply
  params:
    - name: repo-url
      value: git@github.com:adriandolha/cloud-demo.git
    - name: branch-name
      value: master
    - name: argocd-repo-url
      value: git@github.com:adriandolha/lorem-ipsum-argocd.git
    - name: argocd-branch-name
      value: main
    - name: image-url
      value: "docker-registry.demo:5000/lorem-ipsum"
    - name: namespace
      value: "dev-lorem-ipsum"
    - name: tf-path
      value: $(workspaces.source.path)/lorem-ipsum-eks/infrastructure/local
  workspaces:
    - name: source
      persistentVolumeClaim:
        claimName: lorem-ipsum-source-ws
      subPath: source
    - name: terraform
      persistentVolumeClaim:
        claimName: lorem-ipsum-source-ws
      subPath: terraform
    - name: secrets
      persistentVolumeClaim:
        claimName: lorem-ipsum-source-ws
    - name: kube-config
      secret:
        secretName: kubeconfig